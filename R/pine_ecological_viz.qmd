---
title: "Ecological Metrics"
format: html
editor: visual
execute: 
  echo: false
  message: false
  warning: false
  results: false
---

```{r}
# TODO: color blind palettes really only support 9 categories
# TODO: add warnings/errors to calculation functions if the input data is not clean
# TODO: point to updated database
# TODO: remove pulled and missing trees (all instances of them)
# TODO: turn new (all tree) graphs into functions if useful and make them able to scale up
# TODO: what are the white pine species? show only these species on the vitality/infestation graphs
#         also should these graphs really be applied to alive and dead trees?
# TODO: update density functions
library(tidyverse)
library(plotly)
library(viridis)
library(khroma)
```


```{r}
#| output: false

#pine <- fiveneedlepine::loadPine("M:/MONITORING/Pine/Data/Database/Backend/FNP_MOJN_Primary.accdb")

data_dir = here::here("data")
# TODO: change to relative directory
pine <- fiveneedlepine::loadPine("C:/Users/ifoster/Documents/R/mojn-pine-rpackage/data/FNP_MOJN_Primary_Copy.accdb")

# TODO: move this
# Calculates the visit number for each visit to a site
visitNum <- pine$data$Visit %>%
  dplyr::filter(repeatSample != 1) %>%
  dplyr::mutate(year = year(as_date(eventDate))) %>%
  # TODO: make more robust, would a visit to a panel ever be one year off
  # so something like make visit year the year the majority of visits are
  dplyr::select(panel, year)%>%
  dplyr::group_by(panel, year) %>%
  dplyr::summarize(n = n()) %>%
  dplyr::group_by(panel) %>%
  dplyr::mutate(visitNumber = seq_along(year))
  # arrange year descending within panel descending 
  
# Remove seedling plots with no seedlings
pine$data$Seedling <- pine$data$Seedling %>%
  filter(speciesCode != "_NONE") %>%
  # Make a unique identifier for all seedlings
  mutate(uniqueSeedlingID = paste0(locationID, "_", tag)) 

# TODO: there is probably a cleaner way to do this
# Make a table with all of the seedlings that were pulled or missing
pulledSeedlings <- pine$data$Seedling %>%
  filter(vitality == 'P' | vitality == 'M')

# Remove all instances of pulled or missing seedlings based on unique seedling ID
pine$data$Seedling <- pine$data$Seedling %>%
  filter(!(uniqueSeedlingID %in% pulledSeedlings$uniqueSeedlingID)) %>%
  dplyr::select(-uniqueSeedlingID) %>%
  mutate(year = year(as_date(eventDate))) %>%
  # Join with table containing visit number
  left_join(visitNum) %>%
  # TODO update
  filter(!is.na(visitNumber))


# TODO: ONLY INCLUDES LIVE TREES
# Cleaning live tree data for wrangling and visualization
pine$data$Tree <- pine$data$Tree %>%
  # Remove all dead trees
  filter(vitality == "Live") %>%
  # Remove rows where height or DBH that are NA
  filter(!is.na(treeHeight_m) & treeHeight_m != -999 & treeHeight_m != 999) %>%
  filter(!is.na(treeDBH_cm) & treeDBH_cm != -999 & treeDBH_cm != 999) %>%
  mutate(uniqueTreeID = paste(locationID, "_", subplot, "_", tag),
    year = year(as_date(eventDate))) %>%
  # Join with table containing visit number
  left_join(visitNum) %>%
  # TODO update
  filter(!is.na(visitNumber))
```


## Live Trees
::: panel-tabset

##### Basal Area
```{r}
# avg basal area of plots split by communities/year
# TODO: add error bars
source("calculations.R")
treeDominance <- getDominance(pine$data$Tree)

pine$data$Tree %>%
  getBasalArea() %>%
  # find the total basal area of each locationID
  group_by(locationID, visitNumber, sampleFrame) %>%
  summarise(totalPlotBasal = sum(basalArea)) %>%
  group_by(visitNumber, sampleFrame) %>%
  summarise(meanBasalPerPlot = mean(totalPlotBasal)) %>%
  ggplot(aes(x = factor(sampleFrame), y = meanBasalPerPlot, fill = factor(visitNumber))) + 
  geom_col(stat="identity", position = "dodge") + 
  theme_minimal() + 
  labs(title = "Average Basal Area of each Community",
       x = "Community", y = "Basal Area (m^2)",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()


```

##### Tree Count
```{r}
source("calculations.R")

countGraph <- pine$data$Tree %>%
  getTreeCount() %>%
  #filter(locationID == "GRBA_N_002") %>%
  ggplot(aes(x = factor(visitNumber), y = count, fill = factor(speciesCode))) +
  geom_col()  +
  facet_wrap(~locationID) + 
  theme_minimal() + 
  labs(title = "Species Count",
       x = "Visit", y = "Count",
       fill = "Species Code") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5))

plotly::ggplotly(countGraph)
```


##### Density
```{r}
# Species, Total, 5cm DBH bins
# Count of trees / area sampled
# #/ha
# Density of every plot
density <- pine$data$Tree %>%
  mutate(DBHGroup = cut(x = treeDBH_cm, breaks = 5*(0:(max(treeDBH_cm)/5)))) %>%
  group_by(speciesCode, locationID, visitNumber, sampleFrame, DBHGroup) %>%
  summarise(density = n()/0.25) %>%
  # Average dencity
  group_by(speciesCode, DBHGroup, visitNumber) %>%
  summarise(avgDensity = mean(density))

densityGraph <- density %>%
  filter(speciesCode != "JUNSCO" & speciesCode != "PINMON" & speciesCode != "UNK" & speciesCode != "PINPON") %>%
  ggplot(aes(x = factor(DBHGroup), y = avgDensity, color = factor(visitNumber))) +
  geom_point() + 
  geom_line(aes(color = factor(visitNumber), group = factor(visitNumber))) +
  facet_wrap(~speciesCode, scales = "free") + 
  theme_minimal() + 
  labs(title = "Average Density",
       x = "DBH (cm)", y = "Density (#/ha)",
       color = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5, angle = 315)) +
  scale_fill_light()

plotly::ggplotly(densityGraph)
```

##### Frequency
```{r}
frequencyData <- pine$data$Tree %>%
  getFrequency() %>%
  group_by(speciesCode, visitNumber) %>%
  summarise(avgFrequency = mean(frequency)) %>%
  ggplot(aes(x = factor(speciesCode), y = avgFrequency, fill = factor(visitNumber))) +
  geom_col(stat="identity", position = "dodge")  +
  #facet_wrap(~speciesCode) + 
  theme_minimal() + 
  labs(title = "Average Frequency",
       x = "Species", y = "Percent",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5, angle = 315)) +
  scale_fill_light()

plotly::ggplotly(frequencyData)
```

##### Dominance
```{r}
source("calculations.R")

pine$data$Tree %>%
  getDominance() %>%
  filter(speciesCode != "JUNSCO" & speciesCode != "PINMON" & speciesCode != "UNK") %>%
  ggplot(aes(x = factor(speciesCode), y = dominance, fill = factor(visitNumber))) +
  facet_wrap(~speciesCode, scales="free", drop= TRUE) +
  geom_violin() + 
  theme_minimal() + 
  labs(title = "Dominance",
       x = "Species Code", y = "Dominance (m^2/ha)",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()
```

##### Relative Density
```{r}
source("calculations.R")

relativeDensityGraph <- pine$data$Tree %>%
  getRelativeDensity() %>%
  #filter(locationID == "GRBA_N_002") %>%
  ggplot(aes(x = factor(visitNumber), y = relativeDensity, fill = factor(speciesCode))) +
  geom_col()  +
  facet_wrap(~locationID) + 
  theme_minimal() + 
  labs(title = "Relative Density",
       x = "Visit", y = "Relative Density",
       fill = "Species Code") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5, angle = 315))

plotly::ggplotly(relativeDensityGraph)
```


##### Average Relative Frequency
```{r}
source("calculations.R")
relativeFrequency <- pine$data$Tree %>% 
  getFrequency() %>%
  group_by(speciesCode, visitNumber) %>%
  summarise(avgRelativeFrequency = mean(relativeFrequency)) %>%
  ggplot(aes(x = speciesCode, y = avgRelativeFrequency, fill = factor(visitNumber))) +
  geom_col(position = "dodge") + 
  theme_minimal() + 
  labs(title = "Average Relative Frequency",
       x = "Species", y = "Percent",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5, angle = 315)) +
  scale_fill_light()

ggplotly(relativeFrequency)
```


##### Relative Frequency
```{r}
source("calculations.R")
relativeFrequency <- pine$data$Tree %>% 
  getFrequency() %>%
  filter(speciesCode != "JUNSCO") %>%
  ggplot(aes(x = factor(visitNumber), y = relativeFrequency, fill = factor(speciesCode))) +
  geom_col() +
  facet_wrap(~locationID) +
  theme_minimal() + 
  labs(title = "Relative Frequency",
       x = "Species", y = "Percent",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5, angle = 315)) +
  #scale_fill_viridis(length(unique(pine$data$Tree$speciesCode)), option = "A", discrete = TRUE)
  scale_fill_muted()



ggplotly(relativeFrequency)
```

##### Relative Dominance
```{r}
relDomiance <- pine$data$Tree %>%
  getDominance() %>%
  ggplot(aes(x = factor(visitNumber), y = relativeDominance, fill = factor(speciesCode))) +
  geom_col() +
  facet_wrap(~locationID) + 
  theme_minimal() + 
  labs(title = "Relative Dominance",
       x = "Visit Number", y = "Percent",
       fill = "Species Code") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5, angle = 315))

ggplotly(relDomiance)
```

##### Importance Value
```{r}
importanceVal <- pine$data$Tree %>%
  getImportanceValue() %>%
  ggplot(aes(x = factor(visitNumber), y = importanceValue, fill = factor(speciesCode))) +
  geom_col() +
  facet_wrap(~locationID) + 
  theme_minimal() + 
  labs(title = "Importance Value",
       x = "Visit Number", y = "Value",
       fill = "Species Code") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5, angle = 315))

ggplotly(importanceVal)
```

##### Tree Height
```{r}
pine$data$Tree %>%
  filter(speciesCode != "JUNSCO" & speciesCode != "PINMON" & speciesCode != "UNK") %>%
  ggplot(aes(x = factor(speciesCode), y = treeHeight_m, fill = factor(visitNumber))) +
  facet_wrap(~speciesCode, scales="free", drop= TRUE) +
  geom_violin() + 
  theme_minimal() + 
  labs(title = "Tree Height",
       x = "Species Code", y = "Height (m)",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()
```


```{r}
frequency <- pine$data$Tree %>%
  getFrequency(grouping = sampleFrame)
```


:::


## Dead and Recently Dead Trees

::: panel-tabset

```{r}
pineDead <- fiveneedlepine::loadPine("C:/Users/ifoster/Documents/R/mojn-pine-rpackage/data/FNP_MOJN_Primary_Copy.accdb")

pineDead <- pineDead$data$Tree %>%
  filter(vitality == "Dead" | vitality == "Recently Dead") %>%
    mutate(uniqueTreeID = paste(locationID, "_", subplot, "_", tag),
    year = year(as_date(eventDate))) %>%
  # Join with table containing visit number
  left_join(visitNum) %>%
  # TODO update
  filter(!is.na(visitNumber)) %>%
  filter(!is.na(treeDBH_cm) & treeDBH_cm != -999 & treeDBH_cm != 999)
```
##### Count
```{r}
countDeadGraph <- pineDead %>%
  getTreeCount() %>%
  #filter(locationID == "GRBA_N_002") %>%
  ggplot(aes(x = factor(visitNumber), y = count, fill = factor(speciesCode))) +
  geom_col()  +
  facet_wrap(~locationID) + 
  theme_minimal() + 
  labs(title = "Species Count",
       x = "Visit", y = "Count",
       fill = "Species Code") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_muted()

plotly::ggplotly(countDeadGraph)
```


##### Density
```{r}
# Species, Total, 5cm DBH bins
# Count of trees / area sampled
# #/ha
# Density of every plot
densityGraph <- pineDead %>%
  #mutate(DBHGroup = cut(x = treeDBH_cm, breaks = 5*(0:(max(treeDBH_cm)/5)))) %>%
  group_by(speciesCode, locationID, visitNumber) %>%
  summarise(density = n()/0.25) %>%
  group_by(speciesCode) %>%
  filter(n() > 2) %>%
  ungroup() %>%
  ggplot(aes(x = factor(visitNumber), y = density, fill = factor(visitNumber))) +
  geom_violin() + 
  facet_wrap(~speciesCode, scales = "free", drop = TRUE) + 
  theme_minimal() + 
  labs(title = "Density",
       x = "Species", y = "Density (#/ha)",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5, angle = 315)) +
  scale_fill_light()

densityGraph
```


:::

## Tree Status and Infestation
::: panel-tabset

```{r}
pineAliveAndDead <- fiveneedlepine::loadPine("C:/Users/ifoster/Documents/R/mojn-pine-rpackage/data/FNP_MOJN_Primary_Copy.accdb")


# TODO: move this
# Calculates the visit number for each visit to a site
visitNum <- pineAliveAndDead$data$Visit %>%
  dplyr::filter(repeatSample != 1) %>%
  dplyr::mutate(year = year(as_date(eventDate))) %>%
  # TODO: make more robust, would a visit to a panel ever be one year off
  # so something like make visit year the year the majority of visits are
  dplyr::select(panel, year)%>%
  dplyr::group_by(panel, year) %>%
  dplyr::summarize(n = n()) %>%
  dplyr::group_by(panel) %>%
  dplyr::mutate(visitNumber = seq_along(year))
  # arrange year descending within panel descending

# TODO: ONLY INCLUDES LIVE TREES
# Cleaning live tree data for wrangling and visualization
pineAliveAndDead$data$Tree <- pineAliveAndDead$data$Tree %>%
  # Remove rows where height or DBH that are NA
  filter(!is.na(treeHeight_m) & treeHeight_m != -999 & treeHeight_m != 999) %>%
  filter(!is.na(treeDBH_cm) & treeDBH_cm != -999 & treeDBH_cm != 999) %>%
  mutate(uniqueTreeID = paste(locationID, "_", subplot, "_", tag),
    year = year(as_date(eventDate))) %>%
  # Join with table containing visit number
  left_join(visitNum) %>%
  # TODO update
  filter(!is.na(visitNumber))
```


##### Vitality
Fix this one
```{r}
# Species, Total, 5cm DBH bins
# Proportion Live and dead


# proportion alive = number alive / total number
# proportion dead = number dead / total number
treeVitality <- pineAliveAndDead$data$Tree %>%
  mutate(DBHGroup = cut(x = treeDBH_cm, breaks = 5*(0:(max(treeDBH_cm)/5)))) %>%
  group_by(locationID, visitNumber, speciesCode, DBHGroup) %>%
  summarise(alive = mean(vitality == "Live")*100,
            #dead = mean(vitality != "Live")*100, 
            n = n()) %>%
  #pivot_longer(cols = c(alive, dead), names_to = "vitality") %>%
  group_by(visitNumber, speciesCode, DBHGroup) %>%
  summarize(meanProportion = mean(alive)) %>%
  filter(speciesCode != "JUNSCO" & speciesCode != "PINMON" & speciesCode != "UNK" & speciesCode != "PINPON") %>%
  #filter(speciesCode == "ABICON") %>%
  ggplot(aes(x = DBHGroup, y = meanProportion, fill = factor(visitNumber))) +
  geom_col(position = "dodge") +
  facet_wrap(~speciesCode, scales = "free_x") + 
  theme_minimal() + 
  labs(title = "Proportion Alive",
       x = "DBH Group", y = "Proportion",
       fill = "Vitality") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5, angle = 315)) +
  scale_fill_light()
  
ggplotly(treeVitality)          
```


##### Motrality Cause
```{r}
# count of mortality cause by plot

mortalityCause <- pineDead %>%
  group_by(locationID, visitNumber, causeOfDeath) %>%
  summarise(n = n()) %>%
  ggplot(aes(x = factor(visitNumber), y = n, fill = factor(causeOfDeath))) +
  geom_col() +
  facet_wrap(~locationID, scales = "free_y") + 
  theme_minimal() + 
  labs(title = "Mortality cause",
       x = "Visit", y = "Count",
       fill = "Mortality Type") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5, angle = 315)) +
  scale_fill_light()

ggplotly(mortalityCause)
```

##### Crown Kill
```{r}
# Mean percent % crown kill from three sections of tree
# Individual Tree, Species, total

crownKill <- pineAliveAndDead$data$Tree %>%
  filter(!is.na(crownKill_Upper_percent) & !is.na(crownKill_Mid_percent) & !is.na(crownKill_Lower_percent)) %>%
  rowwise() %>%
  mutate(avgCrownKill = mean(c_across(crownKill_Upper_percent:crownKill_Lower_percent))) %>%
  group_by(speciesCode, visitNumber) %>%
  summarise(avgSpeciesCrownKill = mean(avgCrownKill),
            n = n()) %>%
  filter(n > 4) %>%
  ggplot(aes(x = speciesCode, y = avgSpeciesCrownKill, fill = factor(visitNumber))) +
  geom_col(position = position_dodge(preserve = "single")) + 
  theme_minimal() + 
  labs(title = "Mean Crown Kill",
       x = "Species", y = "Crown Kill Percent",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()

ggplotly(crownKill)
```



```{r}
# Canker data wrangling
# TODO: there are no cankers in the data so use test dats with cankers to try out canker graphs 

treeCankerTest <- pineAliveAndDead$data$Tree %>%
  dplyr::filter(dplyr::if_all((contains("Cank") & !contains("Type")), ~ !is.na(.x))) %>%
  select(locationID, boleCankers_A_Lower,boleCankers_A_Mid, branchCanks_I_Upper, branchCanks_I_Mid, visitNumber, speciesCode) %>%
  slice(1:500)


treeCankerTest[sample(1:500, 100, replace=FALSE), 'boleCankers_A_Lower'] =  'Y'
treeCankerTest[sample(1:500, 250, replace=FALSE), 'boleCankers_A_Mid'] =  'Y'
treeCankerTest[sample(1:500, 150, replace=FALSE), c("branchCanks_I_Upper")] = 'Y'
treeCankerTest[sample(1:500, 100, replace=FALSE), 'branchCanks_I_Mid'] = 'Y'

#Cankers <- pineAliveAndDead$data$Tree %>%
cankers <- treeCankerTest %>%  
  # Filter out any canker rows that contains a NA (that are not canker type)
  dplyr::filter(dplyr::if_all((contains("Cank") & !contains("Type")), ~ !is.na(.x))) %>%
  mutate(activeCankers = case_when(
    # If any of the columns that contain the strings "cank" and "_A_" set the active canker marker to Y
    (if_any((contains("Cank") & contains("_A_")), ~ . == 'Y')) ~ 'Y',
    # Otherwise set it to N
    .default = 'N')) %>%
  mutate(inactiveCankers = case_when(
    # If any of the columns that contain the strings "cank" and "_A_" set the active canker marker to Y
    (if_any((contains("Cank") & contains("_I_")), ~ . == 'Y')) ~ 'Y',
    # Otherwise set it to N
    .default = 'N')) %>%
  mutate(anyCankers = case_when(
    # If the active or inactive canker columns are yes, set any canker marker to yes
    (activeCankers == 'Y' | inactiveCankers == 'Y') ~ 'Y',
    # Otherwise set it to N
    .default = 'N'))

```


##### Active Canker Percent
```{r}
# Percent of trees with active cankers by species
# TODO: could group by plot/park/community and then avg it

activeCankerPercent <- cankers %>%
  group_by(visitNumber, speciesCode) %>%
  mutate(totalTrees = n()) %>%
  group_by(visitNumber, speciesCode, activeCankers, totalTrees) %>%
  summarise(numActive = n()) %>%
  mutate(percent = numActive/totalTrees*100) %>%
  # group_by(speciesCode, visitNumber, activeCankers) %>%
  # summarise(avgPercent = mean(percent)) %>%
  ggplot(aes(x = factor(visitNumber), y = percent, fill = activeCankers)) +
  geom_col() +
  facet_wrap(~speciesCode) + 
  theme_minimal() + 
  labs(title = "Active Canker Percent",
       x = "Visit", y = "Percent",
       fill = "Active Cankers") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_viridis(discrete = TRUE)

ggplotly(activeCankerPercent)
```

##### Active Canker Density 
```{r}
# Density of trees with active cankers by species
# Count of trees / area sampled  area =2500 sq m = 0.25 ha
# number/ha

activeCankerDensity <-  cankers %>%
  group_by(visitNumber, speciesCode, activeCankers, locationID) %>%
  summarise(plotDensity = n()/0.25) %>%
  group_by(visitNumber, speciesCode, activeCankers) %>%
  summarise(avgDensity = mean(plotDensity)) %>%
  ggplot(aes(x = factor(visitNumber), y = avgDensity, fill = activeCankers)) +
  geom_col() +
  facet_wrap(~speciesCode) + 
  theme_minimal() + 
  labs(title = "Active Canker Density",
       x = "Visit", y = "Density (#/ha)",
       fill = "Active Cankers") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()
  #scale_fill_discrete(type = ())

ggplotly(activeCankerDensity)
```

##### Inactive Canker Percent
```{r}
# Percent of trees with inactive cankers by species
# TODO: could group by plot/park/community and then avg it

inactiveCankerPercent <- cankers %>%
  group_by(visitNumber, speciesCode) %>%
  mutate(totalTrees = n()) %>%
  group_by(visitNumber, speciesCode, inactiveCankers, totalTrees) %>%
  summarise(numActive = n()) %>%
  mutate(percent = numActive/totalTrees*100) %>%
  # group_by(speciesCode, visitNumber, activeCankers) %>%
  # summarise(avgPercent = mean(percent)) %>%
  ggplot(aes(x = factor(visitNumber), y = percent, fill = inactiveCankers)) +
  geom_col() +
  facet_wrap(~speciesCode) + 
  theme_minimal() + 
  labs(title = "Inactive Canker Percent",
       x = "Visit", y = "Percent",
       fill = "Active Cankers") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()

ggplotly(inactiveCankerPercent)
```


##### Inactive Canker Density
```{r}
# Density of trees with inactive cankers by species
# Count of trees / area sampled  area =2500 sq m = 0.25 ha
# number/ha

activeCankerDensity <-  cankers %>%
  group_by(visitNumber, speciesCode, inactiveCankers, locationID) %>%
  summarise(plotDensity = n()/0.25) %>%
  group_by(visitNumber, speciesCode, inactiveCankers) %>%
  summarise(avgDensity = mean(plotDensity)) %>%
  ggplot(aes(x = factor(visitNumber), y = avgDensity, fill = inactiveCankers)) +
  geom_col() +
  facet_wrap(~speciesCode) + 
  theme_minimal() + 
  labs(title = "Inctive Canker Density",
       x = "Visit", y = "Density (#/ha)",
       fill = "Inactive Cankers") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()
  #scale_fill_discrete(type = ())

ggplotly(activeCankerDensity)
```


##### Canker Percent
```{r}
# Percent of trees with active OR inactive cankers by species
cankerPercent <- cankers %>%
  group_by(visitNumber, speciesCode) %>%
  mutate(totalTrees = n()) %>%
  group_by(visitNumber, speciesCode, anyCankers, totalTrees) %>%
  summarise(numActive = n()) %>%
  mutate(percent = numActive/totalTrees*100) %>%
  # group_by(speciesCode, visitNumber, activeCankers) %>%
  # summarise(avgPercent = mean(percent)) %>%
  ggplot(aes(x = factor(visitNumber), y = percent, fill = anyCankers)) +
  geom_col() +
  facet_wrap(~speciesCode) + 
  theme_minimal() + 
  labs(title = "Canker Percent",
       x = "Visit", y = "Percent",
       fill = "Cankers") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()
  #scale_fill_discrete(type = c("#99DDFF", "#bbcc33"))

ggplotly(cankerPercent)
```

##### Canker Density
```{r}
# Density of trees with active OR inactive cankers by species
# Count of trees / area sampled  area =2500 sq m = 0.25 ha
# number/ha

# TODO White pine species, 5cm DBH bins
activeCankerDensity <-  cankers %>%
  group_by(visitNumber, speciesCode, anyCankers, locationID) %>%
  summarise(plotDensity = n()/0.25) %>%
  group_by(visitNumber, speciesCode, anyCankers) %>%
  summarise(avgDensity = mean(plotDensity)) %>%
  ggplot(aes(x = factor(visitNumber), y = avgDensity, fill = anyCankers)) +
  geom_col() +
  facet_wrap(~speciesCode) + 
  theme_minimal() + 
  labs(title = "Canker Density",
       x = "Visit", y = "Density (#/ha)",
       fill = "Cankers") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()
  #scale_fill_discrete(type = ())

ggplotly(activeCankerDensity)
```

```{r}
# Data wrangling to create one pine beetle marker
pineBeetles <- pineAliveAndDead$data$Tree %>%
  # Filter out any beetle rows that contains a NA
  dplyr::filter(dplyr::if_all((contains("Cank") & !contains("Type")), ~ !is.na(.x))) %>%
  mutate(pineBeetle = case_when(
    # If any of the columns that contain the strings "beetle" set the beetle marker to Y
    (if_any((contains("Beetle")), ~ . == 'Y')) ~ 'Y',
    # Otherwise set it to N
    .default = 'N'))
```


##### Pine Beetle Percent
```{r}
# Percent of trees with beetle sign

beetlePercent <- pineBeetles %>%
  group_by(speciesCode, visitNumber) %>%
  mutate(totalTrees = n()) %>%
  group_by(visitNumber, speciesCode, pineBeetle, totalTrees) %>%
  summarise(numBeetles = n()) %>%
  mutate(percent = numBeetles/totalTrees*100) %>%
  # group_by(speciesCode, visitNumber, activeCankers) %>%
  # summarise(avgPercent = mean(percent)) %>%
  ggplot(aes(x = factor(visitNumber), y = percent, fill = pineBeetle)) +
  geom_col() +
  facet_wrap(~speciesCode) + 
  theme_minimal() + 
  labs(title = "Pine Beetle Percent",
       x = "Visit", y = "Percent",
       fill = "Beetle") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()

ggplotly(beetlePercent)
```


##### Pine Beetle Density
```{r}
# Density of trees with beetle sign
# number/ha

beetleDensity <-  pineBeetles %>%
  group_by(visitNumber, speciesCode, pineBeetle, locationID) %>%
  summarise(plotDensity = n()/0.25) %>%
  group_by(visitNumber, speciesCode, pineBeetle) %>%
  summarise(avgDensity = mean(plotDensity)) %>%
  ggplot(aes(x = factor(visitNumber), y = avgDensity, fill = pineBeetle)) +
  geom_col() +
  facet_wrap(~speciesCode) + 
  theme_minimal() + 
  labs(title = "Pine Beetle Density",
       x = "Visit", y = "Density (#/ha)",
       fill = "Pine Beetles") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()
  #scale_fill_discrete(type = ())

ggplotly(beetleDensity)
```


##### Dwarf Mistletoe Percent
```{r}

mistletoePercent <- pineAliveAndDead$data$Tree %>%
  filter(!is.na(mistletoe) & mistletoe != "ND") %>%
  group_by(speciesCode, visitNumber) %>%
  summarise(percent = mean(mistletoe == 'Y')*100,
            mistletoe = sum(mistletoe == "Y"),
            n = n()) %>%
  ggplot(aes(x = speciesCode, y = percent, fill = factor(visitNumber))) +
  geom_col(position = position_dodge(preserve = "single")) + 
  theme_minimal() + 
  labs(title = "Mistletoe Percent",
       x = "Species", y = "Percent",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()

ggplotly(mistletoePercent)
```

##### Mistletoe Density
```{r}
# number/ha
# Density of trees with mistletoe

mistletoeDensity <- pineAliveAndDead$data$Tree %>%
  filter(!is.na(mistletoe) & mistletoe != "ND") %>%
  group_by(speciesCode, locationID, visitNumber) %>%
  summarise(density = n()/0.25,
            n = n()) %>%
  group_by(speciesCode, visitNumber) %>%
  summarise(avgDensity = mean(density)) %>%
  ggplot(aes(x = speciesCode, y = avgDensity, fill = factor(visitNumber))) +
  geom_col(position = position_dodge(preserve = "single")) + 
  theme_minimal() + 
  labs(title = "Mistletoe Density",
       x = "Species", y = "Density (#/ha)",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()

ggplotly(mistletoeDensity)
```


##### Female Cone Percent
```{r}
femaleConePercent <- pineAliveAndDead$data$Tree %>%
  filter(!is.na(femaleCones)) %>%
  group_by(locationID, speciesCode, visitNumber) %>%
  summarise(percent = mean(femaleCones == "Y")*100,
            yes = sum(femaleCones == "Y"),
            n = n()) %>%
  group_by(speciesCode, visitNumber) %>%
  summarise(avgConePercent = mean(percent)) %>%
  ggplot(aes(x = speciesCode, y = avgConePercent, fill = factor(visitNumber))) +
  geom_col(position = position_dodge(preserve = "single")) + 
  theme_minimal() + 
  labs(title = "Female Cone Percent",
       x = "Species", y = "Percent",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()

ggplotly(femaleConePercent)
```

##### Female Cone Density
```{r}
# number/ha
# Density of trees with female cones

femaleConeDensity <- pineAliveAndDead$data$Tree %>%
  filter(!is.na(femaleCones)) %>%
  group_by(speciesCode, locationID, visitNumber) %>%
  summarise(density = sum(femaleCones == "Y")/0.25,
            n = n()) %>%
  group_by(speciesCode, visitNumber) %>%
  summarise(avgDensity = mean(density)) %>%
  ggplot(aes(x = speciesCode, y = avgDensity, fill = factor(visitNumber))) +
  geom_col(position = position_dodge(preserve = "single")) + 
  theme_minimal() + 
  labs(title = "Cone Density",
       x = "Species", y = "Density (#/ha)",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()

ggplotly(femaleConeDensity)
```


##### Mean Cone count
```{r}
# species, plot

coneCount <- pineAliveAndDead$data$Tree %>%
  filter(!is.na(coneCount) & coneCount != -999 & coneCount != 999) %>%
  group_by(speciesCode, locationID, visitNumber) %>%
  summarise(totalConeCount = sum(coneCount)) %>%
  group_by(speciesCode, visitNumber) %>%
  summarise(avgConeCount = mean(totalConeCount)) %>%
  ggplot(aes(x = speciesCode, y = avgConeCount, fill = factor(visitNumber))) +
  geom_col(position = position_dodge(preserve = "single")) + 
  theme_minimal() + 
  labs(title = "Cone Count",
       x = "Species", y = "Count",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()

ggplotly(coneCount)
```

:::

## Seedlings
::: panel-tabset

##### Count
```{r}
seedlingCount <- pine$data$Seedling %>%
  getTreeCount(grouping = heightClass) %>%
  ggplot(aes(x = factor(visitNumber), y = count, fill = factor(heightClass))) +
  facet_wrap(~speciesCode, scales = "free") +
  geom_col(position = position_dodge(preserve = "single")) + 
  theme_minimal() + 
  labs(title = "Seedling Count",
       x = "Visit", y = "Count",
       fill = "Height Class") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()

ggplotly(seedlingCount)
```

##### Density
```{r}
# number/ha
#species, plot, height class
seedlingDensity <- pine$data$Seedling %>%
  group_by(speciesCode, visitNumber, locationID, heightClass) %>%
  # area of all the seedling transects in one plot: 3*3*9 = 81 m^2
  summarise(density = n()/0.0081) %>%
  group_by(speciesCode, visitNumber, heightClass) %>%
  summarise(avgDensity = mean(density)) %>%
  ggplot(aes(x = factor(visitNumber), y = avgDensity, fill = heightClass)) +
  facet_wrap(~speciesCode, scales = "free") +
  geom_col(position = position_dodge(preserve = "single")) + 
  theme_minimal() + 
  labs(title = "Seedling Density",
       x = "Visit", y = "Density (#/ha)",
       fill = "Height Class") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()

ggplotly(seedlingDensity)
  
```


##### Average Frequency
```{r}
# Area of transects in which a species occurs / total area of transects

seedlingFrequency <- pine$data$Seedling %>%
  getFrequency(transectArea = 9, totalArea = 81) %>%
  group_by(speciesCode, visitNumber) %>%
  summarise(avgFrequency = mean(frequency)) %>%
  ggplot(aes(x = speciesCode, y = avgFrequency, fill = factor(visitNumber))) +
  #facet_wrap(~speciesCode, scales = "free") +
  geom_col(position = position_dodge(preserve = "single")) + 
  theme_minimal() + 
  labs(title = "Average Frequency",
       x = "Species", y = "Percent",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  scale_fill_light()

ggplotly(seedlingFrequency)
```


##### Relative Density
```{r}
seedlingRelDensity <- pine$data$Seedling %>%
  getRelativeDensity(areaSampled = 81) %>% 
  ggplot(aes(x = factor(visitNumber), y = relativeDensity, fill = speciesCode)) +
  geom_col() +
  facet_wrap(~locationID) +
  theme_minimal() + 
  labs(title = "Relative Density",
       x = "Species", y = "Percent",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5, angle = 315)) +
  #scale_fill_viridis(length(unique(pine$data$Tree$speciesCode)), option = "A", discrete = TRUE)
  scale_fill_muted()

ggplotly(seedlingRelDensity)
```


##### Relative Frequency
```{r}
seedlingRelFrequency <- pine$data$Seedling %>%
  getFrequency(transectArea = 9, totalArea = 81) %>% 
  ggplot(aes(x = factor(visitNumber), y = relativeFrequency, fill = speciesCode)) +
  geom_col() +
  facet_wrap(~locationID) +
  theme_minimal() + 
  labs(title = "Relative Frequency",
       x = "Species", y = "Percent",
       fill = "Visit") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5, angle = 315)) +
  #scale_fill_viridis(length(unique(pine$data$Tree$speciesCode)), option = "A", discrete = TRUE)
  scale_fill_muted()

ggplotly(seedlingRelFrequency)
```



:::

